# Лекция. Управляющие конструкции в Angular - `@if`, `@for`, `@switch`

**Цель лекции:** Изучить новые декларативные шаблонные конструкции Angular для условного рендеринга и работы с коллекциями. Понять их преимущества перед старыми структурными директивами и научиться применять на практике.

**Аудитория:** Студенты, знакомые с основами Angular и шаблонами.

---

### **План лекции:**

1.  **Введение: Эволюция управляющих конструкций**
    *   От структурных директив к встроенным конструкциям.
    *   Преимущества новых синтаксисов.

2.  **Условный рендеринг с `@if`**
    *   Базовый синтаксис.
    *   `@else` и `@else if`.
    *   Сравнение с `*ngIf`.

3.  **Циклы с `@for`**
    *   Базовый синтаксис и контекстные переменные.
    *   `track` - важность отслеживания элементов.
    *   Специальные переменные (`$index`, `$first`, `$last`, `$even`, `$odd`).
    *   Блок `@empty`.
    *   Сравнение с `*ngFor`.

4.  **Конструкция `@switch`**
    *   Синтаксис `@switch`, `@case`, `@default`.
    *   Сравнение с `*ngSwitch`.

5.  **Практическое применение**
    *   Создание компонента списка задач (Todo List).
    *   Компонент загрузки данных с различными состояниями.

---

### **Детальное рассмотрение каждого пункта плана:**

#### **1. Введение: Эволюция управляющих конструкций**

**От структурных директив к встроенным конструкциям:**
В Angular 17+ появились новые **встроенные шаблонные конструкции**, которые пришли на смену структурным директивам:
- `@if` вместо `*ngIf`
- `@for` вместо `*ngFor` 
- `@switch` вместо `*ngSwitch`

**Преимущества новых синтаксисов:**
- **Лучшая типобезопасность** - улучшенная проверка типов TypeScript
- **Более интуитивный синтаксис** - похоже на обычные JavaScript конструкции
- **Улучшенная производительность** - особенно для `@for` с автоматической оптимизацией
- **Лучшая эргономика** - проще читать и писать сложные условия

---

#### **2. Условный рендеринг с `@if`**

**Базовый синтаксис:**
```html
@if (condition) {
  <!-- Контент показывается когда condition = true -->
  <p>Элемент отображается!</p>
}
```

**Пример с переменной:**
```typescript
// component.ts
export class MyComponent {
  isLoggedIn = true;
  userRole = 'admin';
  items = [];
}
```

```html
<!-- component.html -->
@if (isLoggedIn) {
  <button>Выйти</button>
}

@if (userRole === 'admin') {
  <button>Панель администратора</button>
}
```

**`@else` и `@else if`:**
```html
@if (score >= 90) {
  <p>Отлично!</p>
} @else if (score >= 70) {
  <p>Хорошо</p>
} @else if (score >= 50) {
  <p>Удовлетворительно</p>
} @else {
  <p>Неудовлетворительно</p>
}
```

**Сравнение с `*ngIf`:**
```html
<!-- Старый способ (не рекомендуется для новых проектов) -->
<div *ngIf="isVisible; else elseBlock">Основной контент</div>
<ng-template #elseBlock>Альтернативный контент</ng-template>

<!-- Новый способ (рекомендуется) -->
@if (isVisible) {
  <div>Основной контент</div>
} @else {
  <div>Альтернативный контент</div>
}
```

---

#### **3. Циклы с `@for`**

**Базовый синтаксис и контекстные переменные:**
```typescript
// component.ts
export class ProductListComponent {
  products = [
    { id: 1, name: 'Ноутбук', price: 1000, inStock: true },
    { id: 2, name: 'Мышь', price: 25, inStock: false },
    { id: 3, name: 'Клавиатура', price: 75, inStock: true }
  ];
}
```

```html
<!-- component.html -->
<ul>
  @for (product of products; track product.id) {
    <li>
      <h3>{{ product.name }}</h3>
      <p>Цена: {{ product.price }}$</p>
      @if (product.inStock) {
        <span class="in-stock">В наличии</span>
      } @else {
        <span class="out-of-stock">Нет в наличии</span>
      }
    </li>
  }
</ul>
```

**`track` - важность отслеживания элементов:**
Ключевое слово `track` **ОБЯЗАТЕЛЬНО** для производительности. Оно помогает Angular отслеживать элементы при изменениях массива.

```html
<!-- ХОРОШО: уникальный идентификатор -->
@for (user of users; track user.id) { ... }

<!-- НОРМАЛЬНО: индекс (менее эффективно) -->
@for (item of items; track $index) { ... }

<!-- ПЛОХО: объект (может вызвать проблемы с производительностью) -->
@for (product of products; track product) { ... }

<!-- ОЧЕНЬ ПЛОХО: без track (Angular выдаст ошибку) -->
@for (item of items) { ... }
```

**Специальные переменные:**
```html
<table>
  @for (user of users; track user.id; let i = $index, f = $first, l = $last, e = $even, o = $odd) {
    <tr [class.first-row]="f" [class.last-row]="l" [class.even-row]="e" [class.odd-row]="o">
      <td>{{ i + 1 }}</td>
      <td>{{ user.name }}</td>
      <td>{{ user.email }}</td>
    </tr>
  }
</table>
```

**Блок `@empty`:**
Показывается когда массив пустой:

```typescript
// component.ts
emptyArray: any[] = [];
```

```html
<!-- component.html -->
<ul>
  @for (item of emptyArray; track $index) {
    <li>{{ item }}</li>
  } @empty {
    <li class="empty-message">Список пуст</li>
  }
</ul>
```

**Сравнение с `*ngFor`:**
```html
<!-- Старый способ -->
<div *ngFor="let product of products; let i = index; trackBy: trackById">
  {{ i }}: {{ product.name }}
</div>

<!-- Новый способ -->
@for (product of products; track product.id; let i = $index) {
  <div>{{ i }}: {{ product.name }}</div>
}
```

---

#### **4. Конструкция `@switch`**

**Синтаксис `@switch`, `@case`, `@default`:**
```typescript
// component.ts
export class NotificationComponent {
  alertLevel = 'warning'; // 'info', 'success', 'warning', 'error'
}
```

```html
<!-- component.html -->
@switch (alertLevel) {
  @case ('info') {
    <div class="alert alert-info">
      <i class="icon-info"></i>
      Информационное сообщение
    </div>
  }
  @case ('success') {
    <div class="alert alert-success">
      <i class="icon-check"></i>
      Операция выполнена успешно!
    </div>
  }
  @case ('warning') {
    <div class="alert alert-warning">
      <i class="icon-warning"></i>
      Внимание! Возникла проблема.
    </div>
  }
  @case ('error') {
    <div class="alert alert-danger">
      <i class="icon-error"></i>
      Ошибка! Что-то пошло не так.
    </div>
  }
  @default {
    <div class="alert alert-secondary">
      Неизвестный тип уведомления
    </div>
  }
}
```

**Сравнение с `*ngSwitch`:**
```html
<!-- Старый способ -->
<div [ngSwitch]="alertLevel">
  <div *ngSwitchCase="'info'">Информация</div>
  <div *ngSwitchCase="'success'">Успех</div>
  <div *ngSwitchDefault>По умолчанию</div>
</div>

<!-- Новый способ -->
@switch (alertLevel) {
  @case ('info') { <div>Информация</div> }
  @case ('success') { <div>Успех</div> }
  @default { <div>По умолчанию</div> }
}
```

---

#### **5. Практическое применение**

**Компонент списка задач (Todo List):**
```typescript
// todo-list.component.ts
export class TodoListComponent {
  todos = [
    { id: 1, text: 'Изучить Angular', completed: true },
    { id: 2, text: 'Написать приложение', completed: false },
    { id: 3, text: 'Протестировать код', completed: false }
  ];
  
  newTodoText = '';

  addTodo() {
    if (this.newTodoText.trim()) {
      this.todos.push({
        id: Date.now(), // простой способ получить уникальный ID
        text: this.newTodoText,
        completed: false
      });
      this.newTodoText = '';
    }
  }

  deleteTodo(id: number) {
    this.todos = this.todos.filter(todo => todo.id !== id);
  }

  toggleTodo(id: number) {
    const todo = this.todos.find(t => t.id === id);
    if (todo) {
      todo.completed = !todo.completed;
    }
  }
}
```

```html
<!-- todo-list.component.html -->
<div class="todo-container">
  <h2>Мой список задач</h2>
  
  <!-- Форма добавления -->
  <div class="add-todo">
    <input 
      type="text" 
      [(ngModel)]="newTodoText" 
      placeholder="Новая задача..."
      (keyup.enter)="addTodo()"
    >
    <button (click)="addTodo()">Добавить</button>
  </div>

  <!-- Список задач -->
  <div class="todo-list">
    @for (todo of todos; track todo.id) {
      <div class="todo-item" [class.completed]="todo.completed">
        <input 
          type="checkbox" 
          [checked]="todo.completed"
          (change)="toggleTodo(todo.id)"
        >
        <span class="todo-text">{{ todo.text }}</span>
        <button (click)="deleteTodo(todo.id)" class="delete-btn">×</button>
      </div>
    } @empty {
      <div class="empty-state">
        🎉 Все задачи выполнены! Добавьте новую задачу.
      </div>
    }
  </div>

  <!-- Статистика -->
  <div class="stats">
    @if (todos.length > 0) {
      <p>
        Всего: {{ todos.length }} | 
        Выполнено: {{ todos.filter(t => t.completed).length }} |
        Осталось: {{ todos.filter(t => !t.completed).length }}
      </p>
    }
  </div>
</div>
```

**Компонент загрузки данных:**
```typescript
// data-loader.component.ts
export class DataLoaderComponent {
  data: any[] = [];
  loading = true;
  error: string | null = null;

  ngOnInit() {
    this.loadData();
  }

  async loadData() {
    try {
      this.loading = true;
      this.error = null;
      
      // Имитация HTTP-запроса
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Случайные данные
      this.data = [
        { id: 1, name: 'Элемент 1' },
        { id: 2, name: 'Элемент 2' },
        { id: 3, name: 'Элемент 3' }
      ];
      
    } catch (err) {
      this.error = 'Ошибка загрузки данных';
    } finally {
      this.loading = false;
    }
  }
}
```

```html
<!-- data-loader.component.html -->
@if (loading) {
  <div class="loading-spinner">
    ⏳ Загрузка данных...
  </div>
} @else if (error) {
  <div class="error-message">
    ❌ {{ error }}
    <button (click)="loadData()">Повторить</button>
  </div>
} @else {
  <div class="data-content">
    <h3>Загруженные данные:</h3>
    <ul>
      @for (item of data; track item.id) {
        <li>{{ item.name }}</li>
      } @empty {
        <li>Нет данных для отображения</li>
      }
    </ul>
  </div>
}
```

---

### **Резюме**

*   **`@if`** - замена `*ngIf`, более читаемый синтаксис с поддержкой `@else` и `@else if`
*   **`@for`** - замена `*ngFor`, требует обязательного указания `track` для производительности
*   **`@empty`** - удобный блок для пустых коллекций
*   **`@switch`** - замена `*ngSwitch`, более типобезопасный подход
*   **Контекстные переменные** (`$index`, `$first`, и т.д.) доступны в `@for`
*   **Новый синтаксис** более интуитивен, производителен и типобезопасен

**Рекомендация:** В новых проектах используйте встроенные конструкции (`@if`, `@for`, `@switch`) вместо структурных директив.

---

### **Контрольные вопросы:**

1.  Почему ключевое слово `track` обязательно в конструкции `@for` и как правильно его использовать?
2.  В чем основные преимущества нового синтаксиса `@if` по сравнению с `*ngIf`?
3.  Как отобразить сообщение "Список пуст" когда массив не содержит элементов, используя `@for`?
4.  Какие контекстные переменные доступны внутри блока `@for` и для чего они используются?
5.  Как создать условный рендеринг с тремя различными состояниями (загрузка, ошибка, данные) используя `@if`?
6.  В чем разница между `@switch` и цепочкой `@if`/`@else if`? Когда что использовать?
7.  Почему использование объекта в `track` может быть проблематичным для производительности?
8.  Как получить доступ к индексу элемента внутри `@for` без использования `let i = $index`?
9.  Можно ли использовать `@if` внутри `@for`? Приведите пример.
10. Что произойдет если в `@switch` не будет подходящего `@case` и отсутствует `@default`?