# Практическая работа. Сортировка, фильтрация, поиск, пагинация и группировка в Entity Framework

## Тема
Реализация операций сортировки, фильтрации, поиска, пагинации и группировки данных с использованием Entity Framework Core в ASP.NET Core приложении.

## Цель
Освоить практические навыки работы с основными операциями обработки данных в Entity Framework Core:
- Сортировка данных по различным критериям
- Фильтрация данных по условиям
- Поиск данных по текстовым полям
- Пагинация для работы с большими наборами данных
- Группировка данных для аналитических выборок

## Теоретическая часть

### Entity Framework Core Operations

**Сортировка (Sorting)**
```csharp
// Простая сортировка
var users = context.Users.OrderBy(u => u.LastName);

// Сортировка по убыванию
var users = context.Users.OrderByDescending(u => u.CreatedDate);

// Множественная сортировка
var users = context.Users
    .OrderBy(u => u.LastName)
    .ThenBy(u => u.FirstName);
```

**Фильтрация (Filtering)**
```csharp
// Фильтрация по условию
var activeUsers = context.Users.Where(u => u.IsActive);

// Фильтрация по диапазону
var recentUsers = context.Users
    .Where(u => u.CreatedDate >= DateTime.Now.AddMonths(-1));
```

**Поиск (Searching)**
```csharp
// Поиск по текстовому полю
var searchResults = context.Users
    .Where(u => u.LastName.Contains(searchTerm) || 
                u.FirstName.Contains(searchTerm));
```

**Пагинация (Pagination)**
```csharp
var pageSize = 10;
var pageNumber = 1;

var pagedUsers = context.Users
    .Skip((pageNumber - 1) * pageSize)
    .Take(pageSize);
```

**Группировка (Grouping)**
```csharp
// Группировка с агрегацией
var userGroups = context.Users
    .GroupBy(u => u.Department)
    .Select(g => new {
        Department = g.Key,
        Count = g.Count(),
        AverageSalary = g.Average(u => u.Salary)
    });
```

## Практический пример

### Модель данных
```csharp
public class Student
{
    public int Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public string Email { get; set; }
    public string Group { get; set; }
    public decimal AverageGrade { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public bool IsActive { get; set; }
    public string Department { get; set; }
}

public class Course
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Description { get; set; }
    public int Credits { get; set; }
    public string Instructor { get; set; }
    public DateTime StartDate { get; set; }
    public bool IsActive { get; set; }
}
```

### Сервис для работы с данными
```csharp
public class StudentService
{
    private readonly ApplicationDbContext _context;

    public StudentService(ApplicationDbContext context)
    {
        _context = context;
    }

    public async Task<PaginatedResult<Student>> GetStudentsAsync(
        string searchTerm = null,
        string sortBy = "LastName",
        bool sortDescending = false,
        string groupFilter = null,
        bool? isActive = null,
        int pageNumber = 1,
        int pageSize = 10)
    {
        var query = _context.Students.AsQueryable();

        // Поиск
        if (!string.IsNullOrEmpty(searchTerm))
        {
            query = query.Where(s =>
                s.FirstName.Contains(searchTerm) ||
                s.LastName.Contains(searchTerm) ||
                s.Email.Contains(searchTerm) ||
                s.Group.Contains(searchTerm));
        }

        // Фильтрация
        if (!string.IsNullOrEmpty(groupFilter))
        {
            query = query.Where(s => s.Group == groupFilter);
        }

        if (isActive.HasValue)
        {
            query = query.Where(s => s.IsActive == isActive.Value);
        }

        // Сортировка
        query = sortBy.ToLower() switch
        {
            "firstname" => sortDescending 
                ? query.OrderByDescending(s => s.FirstName)
                : query.OrderBy(s => s.FirstName),
            "email" => sortDescending 
                ? query.OrderByDescending(s => s.Email)
                : query.OrderBy(s => s.Email),
            "averagegrade" => sortDescending 
                ? query.OrderByDescending(s => s.AverageGrade)
                : query.OrderBy(s => s.AverageGrade),
            "enrollmentdate" => sortDescending 
                ? query.OrderByDescending(s => s.EnrollmentDate)
                : query.OrderBy(s => s.EnrollmentDate),
            _ => sortDescending 
                ? query.OrderByDescending(s => s.LastName)
                : query.OrderBy(s => s.LastName)
        };

        // Пагинация
        var totalCount = await query.CountAsync();
        var items = await query
            .Skip((pageNumber - 1) * pageSize)
            .Take(pageSize)
            .ToListAsync();

        return new PaginatedResult<Student>
        {
            Items = items,
            TotalCount = totalCount,
            PageNumber = pageNumber,
            PageSize = pageSize
        };
    }

    public async Task<List<GroupResult>> GetStudentsByGroupAsync()
    {
        return await _context.Students
            .GroupBy(s => s.Group)
            .Select(g => new GroupResult
            {
                GroupName = g.Key,
                StudentCount = g.Count(),
                AverageGrade = g.Average(s => s.AverageGrade)
            })
            .OrderBy(g => g.GroupName)
            .ToListAsync();
    }
}

public class PaginatedResult<T>
{
    public List<T> Items { get; set; }
    public int TotalCount { get; set; }
    public int PageNumber { get; set; }
    public int PageSize { get; set; }
    public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
}

public class GroupResult
{
    public string GroupName { get; set; }
    public int StudentCount { get; set; }
    public decimal AverageGrade { get; set; }
}
```

## Ход работы

1. Создать новое ASP.NET Core Web Application (MVC)
2. Добавить модели данных Student и Course
3. Создать DbContext и настроить подключение к базе данных
4. Реализовать миграции и создать базу данных
5. Создать сервис для работы со студентами с методами сортировки, фильтрации, поиска, пагинации и группировки
6. Создать контроллер с действиями для отображения данных
7. Реализовать представления с формами для фильтрации и поиска
8. Добавить пагинацию в представления
9. Реализовать группировку данных
10. Протестировать все функции приложения

## Варианты заданий

### Вариант 1
Реализовать систему управления студентами с возможностью:
- Сортировки по фамилии, дате зачисления, среднему баллу
- Фильтрации по группе и активности
- Поиска по ФИО и email
- Пагинации по 5 записей на странице
- Группировки по факультетам с подсчетом количества студентов

### Вариант 2
Создать каталог книг с функциями:
- Сортировки по названию, автору, дате издания
- Фильтрации по жанру и доступности
- Поиска по названию и описанию
- Пагинации по 8 записей на странице
- Группировки по авторам с подсчетом книг

### Вариант 3
Разработать систему учета сотрудников с:
- Сортировкой по должности, зарплате, дате найма
- Фильтрацией по отделу и статусу
- Поиском по имени и email
- Пагинацией по 7 записей на странице
- Группировкой по отделам с средней зарплатой

### Вариант 4
Создать систему управления продуктами с:
- Сортировкой по цене, названию, дате добавления
- Фильтрацией по категории и наличию
- Поиском по названию и описанию
- Пагинацией по 6 записей на странице
- Группировкой по категориям с подсчетом продуктов

### Вариант 5
Реализовать систему заказов с:
- Сортировкой по дате, сумме, статусу
- Фильтрацией по клиенту и периоду
- Поиском по номеру заказа
- Пагинацией по 10 записей на странице
- Группировкой по месяцам с суммой заказов

### Вариант 6
Создать систему учета проектов с:
- Сортировкой по названию, deadline, приоритету
- Фильтрацией по статусу и менеджеру
- Поиском по названию и описанию
- Пагинацией по 5 записей на странице
- Группировкой по статусам с количеством проектов

### Вариант 7
Разработать систему билетов с:
- Сортировкой по цене, дате события, месту
- Фильтрацией по типу события и доступности
- Поиском по названию события
- Пагинацией по 12 записей на странице
- Группировкой по типам событий с общей выручкой

### Вариант 8
Создать систему учета автомобилей с:
- Сортировкой по марке, году, цене
- Фильтрацией по типу кузова и статусу
- Поиском по модели и VIN
- Пагинацией по 9 записей на странице
- Группировкой по маркам со средней ценой

### Вариант 9
Реализовать систему статей блога с:
- Сортировкой по дате публикации, заголовку, рейтингу
- Фильтрацией по категории и статусу публикации
- Поиском по заголовку и содержанию
- Пагинацией по 8 записей на странице
- Группировкой по авторам с количеством статей

### Вариант 10
Создать систему учета задач с:
- Сортировкой по приоритету, сроку, статусу
- Фильтрацией по исполнителю и проекту
- Поиском по названию и описанию
- Пагинацией по 15 записей на странице
- Группировкой по исполнителям с количеством задач

### Вариант 11
Разработать систему складского учета с:
- Сортировкой по названию, количеству, дате поступления
- Фильтрацией по категории и поставщику
- Поиском по названию и артикулу
- Пагинацией по 10 записей на странице
- Группировкой по категориям с общей стоимостью

### Вариант 12
Создать систему бронирования отелей с:
- Сортировкой по цене, рейтингу, дате заезда
- Фильтрацией по типу номера и доступности
- Поиском по названию отеля и местоположению
- Пагинацией по 6 записей на странице
- Группировкой по городам с количеством отелей

### Вариант 13
Реализовать систему курсов с:
- Сортировкой по названию, продолжительности, цене
- Фильтрацией по категории и уровню сложности
- Поиском по названию и описанию
- Пагинацией по 8 записей на странице
- Группировкой по инструкторам с количеством курсов

### Вариант 14
Создать систему медицинских записей с:
- Сортировкой по дате визита, пациенту, доктору
- Фильтрацией по отделению и типу визита
- Поиском по диагнозу и симптомам
- Пагинацией по 7 записей на странице
- Группировкой по докторам с количеством пациентов

### Вариант 15
Разработать систему финансовых транзакций с:
- Сортировкой по сумме, дате, категории
- Фильтрацией по типу операции и периоду
- Поиском по описанию и контрагенту
- Пагинацией по 20 записей на странице
- Группировкой по категориям с общей суммой

## Критерии оценки

**5 (Отлично)**
- Все функции работают корректно
- Код хорошо структурирован и комментирован
- Реализованы все требуемые операции
- Присутствует обработка ошибок
- Интерфейс удобен и функционален
- Git репозиторий правильно оформлен

**4 (Хорошо)**
- Основные функции работают корректно
- Незначительные недочеты в реализации
- Отсутствуют некоторые дополнительные функции
- Код в основном хорошо организован

**3 (Удовлетворительно)**
- Базовые функции реализованы
- Есть существенные недочеты в коде
- Не все операции работают корректно
- Проблемы с интерфейсом или функциональностью

**2 (Неудовлетворительно)**
- Основные функции не работают
- Код неорганизован и содержит критические ошибки
- Задание не выполнено

## Контрольные вопросы

1. Какие методы LINQ используются для сортировки данных в EF Core?
2. Как реализовать пагинацию с помощью методов Skip и Take?
3. В чем разница между Where и FirstOrDefault при фильтрации?
4. Как выполнить группировку с агрегатными функциями?
5. Какие преимущества дает использование AsQueryable()?
6. Как оптимизировать запросы с множественными условиями фильтрации?
7. Что такое отложенное выполнение запросов в EF Core?
8. Как реализовать поиск по нескольким полям одновременно?
9. Какие способы сортировки по динамическому полю вы знаете?
10. Как организовать код для повторного использования операций фильтрации?

---

# Пример README.md для варианта 1

```markdown
# Практическая работа №X
## Сортировка, фильтрация, поиск, пагинация и группировка в EF

**Вариант: 1**
**Студент: [ФИО]**
**Группа: [Номер группы]**

### Задание
Реализовать систему управления студентами с возможностью:
- Сортировки по фамилии, дате зачисления, среднему баллу
- Фильтрации по группе и активности
- Поиска по ФИО и email
- Пагинации по 5 записей на странице
- Группировки по факультетам с подсчетом количества студентов

### Реализация

#### Модель Student
```csharp
public class Student
{
    public int Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public string Email { get; set; }
    public string Group { get; set; }
    public decimal AverageGrade { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public bool IsActive { get; set; }
    public string Department { get; set; }
}
```

#### Сервис для работы со студентами
```csharp
public class StudentService
{
    private readonly ApplicationDbContext _context;

    public StudentService(ApplicationDbContext context)
    {
        _context = context;
    }

    public async Task<PaginatedResult<Student>> GetStudentsAsync(
        string searchTerm = null,
        string sortBy = "LastName",
        bool sortDescending = false,
        string groupFilter = null,
        bool? isActive = null,
        int pageNumber = 1,
        int pageSize = 5)
    {
        var query = _context.Students.AsQueryable();

        // Поиск
        if (!string.IsNullOrEmpty(searchTerm))
        {
            query = query.Where(s =>
                s.FirstName.Contains(searchTerm) ||
                s.LastName.Contains(searchTerm) ||
                s.Email.Contains(searchTerm));
        }

        // Фильтрация по группе
        if (!string.IsNullOrEmpty(groupFilter))
        {
            query = query.Where(s => s.Group == groupFilter);
        }

        // Фильтрация по активности
        if (isActive.HasValue)
        {
            query = query.Where(s => s.IsActive == isActive.Value);
        }

        // Сортировка
        query = sortBy.ToLower() switch
        {
            "firstname" => sortDescending 
                ? query.OrderByDescending(s => s.FirstName)
                : query.OrderBy(s => s.FirstName),
            "email" => sortDescending 
                ? query.OrderByDescending(s => s.Email)
                : query.OrderBy(s => s.Email),
            "averagegrade" => sortDescending 
                ? query.OrderByDescending(s => s.AverageGrade)
                : query.OrderBy(s => s.AverageGrade),
            "enrollmentdate" => sortDescending 
                ? query.OrderByDescending(s => s.EnrollmentDate)
                : query.OrderBy(s => s.EnrollmentDate),
            _ => sortDescending 
                ? query.OrderByDescending(s => s.LastName)
                : query.OrderBy(s => s.LastName)
        };

        // Пагинация
        var totalCount = await query.CountAsync();
        var items = await query
            .Skip((pageNumber - 1) * pageSize)
            .Take(pageSize)
            .ToListAsync();

        return new PaginatedResult<Student>
        {
            Items = items,
            TotalCount = totalCount,
            PageNumber = pageNumber,
            PageSize = pageSize
        };
    }

    public async Task<List<GroupResult>> GetStudentsByDepartmentAsync()
    {
        return await _context.Students
            .GroupBy(s => s.Department)
            .Select(g => new GroupResult
            {
                DepartmentName = g.Key,
                StudentCount = g.Count(),
                AverageGrade = g.Average(s => s.AverageGrade)
            })
            .OrderBy(g => g.DepartmentName)
            .ToListAsync();
    }
}
```

### Скриншоты работы программы

![Главная страница](/images/main-page.png)
*Главная страница со списком студентов*

![Фильтрация и поиск](/images/filter-search.png)
*Фильтрация и поиск студентов*

![Группировка по факультетам](/images/grouping.png)
*Группировка студентов по факультетам*

### Запуск проекта
1. Клонировать репозиторий
2. Восстановить пакеты NuGet
3. Выполнить миграции: `Update-Database`
4. Запустить приложение

```
dotnet ef database update
dotnet run
```
```