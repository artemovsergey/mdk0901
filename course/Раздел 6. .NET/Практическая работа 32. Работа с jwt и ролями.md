# Практическая работа. Работа с JWT и ролями в ASP.NET Core

## Тема
Аутентификация и авторизация в ASP.NET Core Web API с использованием JWT токенов и системы ролей

## Цель
Освоить принципы реализации аутентификации и авторизации в веб-приложениях на основе JWT токенов, научиться работать с системой ролей для разграничения доступа к ресурсам API.

## Теоретическая часть

### JWT (JSON Web Token)
JWT - это открытый стандарт для создания токенов доступа, который позволяет передавать информацию между сторонами в виде JSON-объекта. Токен состоит из трех частей:
- **Header** - содержит информацию о типе токена и алгоритме шифрования
- **Payload** - содержит claims (утверждения) о пользователе
- **Signature** - обеспечивает проверку подлинности токена

### Роли в ASP.NET Core
Система ролей позволяет разграничивать доступ к ресурсам приложения на основе ролей пользователя. В ASP.NET Core для этого используются:
- `[Authorize(Roles = "RoleName")]` - атрибут для ограничения доступа
- `User.IsInRole("RoleName")` - проверка роли в коде

## Ход работы

### Практический пример

#### 1. Создание проекта
```bash
dotnet new webapi -n JwtRoleAuth
cd JwtRoleAuth
```

#### 2. Установка необходимых пакетов
```bash
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package System.IdentityModel.Tokens.Jwt
```

#### 3. Модели данных
```csharp
// Models/User.cs
public class User
{
    public int Id { get; set; }
    public string Username { get; set; }
    public string Password { get; set; }
    public string Role { get; set; }
}

// Models/LoginModel.cs
public class LoginModel
{
    public string Username { get; set; }
    public string Password { get; set; }
}
```

#### 4. Сервис для работы с JWT
```csharp
// Services/JwtService.cs
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

public class JwtService
{
    private readonly string _secretKey;
    private readonly string _issuer;
    private readonly string _audience;

    public JwtService(IConfiguration configuration)
    {
        _secretKey = configuration["Jwt:SecretKey"];
        _issuer = configuration["Jwt:Issuer"];
        _audience = configuration["Jwt:Audience"];
    }

    public string GenerateToken(string username, string role)
    {
        var claims = new[]
        {
            new Claim(ClaimTypes.Name, username),
            new Claim(ClaimTypes.Role, role),
            new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
        };

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_secretKey));
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            issuer: _issuer,
            audience: _audience,
            claims: claims,
            expires: DateTime.Now.AddHours(1),
            signingCredentials: creds);

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}
```

#### 5. Контроллер аутентификации
```csharp
// Controllers/AuthController.cs
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly JwtService _jwtService;
    private readonly List<User> _users = new()
    {
        new User { Id = 1, Username = "admin", Password = "admin123", Role = "Admin" },
        new User { Id = 2, Username = "user", Password = "user123", Role = "User" },
        new User { Id = 3, Username = "manager", Password = "manager123", Role = "Manager" }
    };

    public AuthController(JwtService jwtService)
    {
        _jwtService = jwtService;
    }

    [HttpPost("login")]
    public IActionResult Login([FromBody] LoginModel login)
    {
        var user = _users.FirstOrDefault(u => u.Username == login.Username && u.Password == login.Password);
        
        if (user == null)
            return Unauthorized("Invalid credentials");

        var token = _jwtService.GenerateToken(user.Username, user.Role);
        
        return Ok(new { Token = token, Username = user.Username, Role = user.Role });
    }
}
```

#### 6. Защищенные контроллеры
```csharp
// Controllers/AdminController.cs
[ApiController]
[Route("api/[controller]")]
[Authorize(Roles = "Admin")]
public class AdminController : ControllerBase
{
    [HttpGet("data")]
    public IActionResult GetAdminData()
    {
        return Ok(new { Message = "This is admin data", User = User.Identity.Name });
    }
}

// Controllers/UserController.cs
[ApiController]
[Route("api/[controller]")]
[Authorize(Roles = "User,Admin")]
public class UserController : ControllerBase
{
    [HttpGet("data")]
    public IActionResult GetUserData()
    {
        return Ok(new { Message = "This is user data", User = User.Identity.Name });
    }
}
```

#### 7. Настройка Program.cs
```csharp
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// JWT Configuration
builder.Services.AddSingleton<JwtService>();
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:SecretKey"]))
        };
    });

builder.Services.AddAuthorization();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
```

#### 8. appsettings.json
```json
{
  "Jwt": {
    "SecretKey": "YourSuperSecretKeyHereThatIsAtLeast32CharactersLong!",
    "Issuer": "JwtRoleAuth",
    "Audience": "JwtRoleAuthUsers"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

## Варианты заданий

### Вариант 1
Создайте API endpoint для регистрации новых пользователей с валидацией данных.

### Вариант 2
Реализуйте функционал обновления JWT токена при истечении срока действия.

### Вариант 3
Добавьте систему разрешений (Permissions) в дополнение к ролям.

### Вариант 4
Создайте endpoint для изменения пароля пользователя.

### Вариант 5
Реализуйте логаут с добавлением токена в черный список.

### Вариант 6
Добавьте endpoint для получения информации о текущем пользователе.

### Вариант 7
Создайте систему аудита действий пользователей.

### Вариант 8
Реализуйте ограничение количества попыток входа.

### Вариант 9
Добавьте подтверждение email при регистрации.

### Вариант 10
Создайте API для управления ролями пользователей (только для администраторов).

### Вариант 11
Реализуйте двухфакторную аутентификацию.

### Вариант 12
Добавьте endpoint для сброса пароля по email.

### Вариант 13
Создайте систему сессий пользователей.

### Вариант 14
Реализуйте авторизацию на основе политик (Policies).

### Вариант 15
Добавьте ведение истории входов пользователя.

## Критерии оценки

**5 (Отлично):**
- Полностью реализовано задание по варианту
- Код хорошо структурирован и соответствует стандартам
- Присутствует обработка ошибок
- Добавлены дополнительные улучшения
- Репозиторий правильно оформлен

**4 (Хорошо):**
- Основной функционал реализован
- Есть небольшие недочеты в архитектуре
- Частично реализована обработка ошибок
- Репозиторий соответствует требованиям

**3 (Удовлетворительно):**
- Реализован базовый функционал
- Есть архитектурные недочеты
- Отсутствует обработка ошибок
- Репозиторий оформлен с недочетами

**2 (Неудовлетворительно):**
- Функционал не реализован или работает некорректно
- Критические ошибки в архитектуре
- Репозиторий не соответствует требованиям

## Контрольные вопросы

1. Что такое JWT и из каких частей он состоит?
2. Как работает процесс аутентификации с JWT?
3. Чем отличается аутентификация от авторизации?
4. Как реализована проверка ролей в ASP.NET Core?
5. Какие преимущества и недостатки у JWT по сравнению с сессиями?
6. Как обеспечить безопасное хранение секретного ключа?
7. Что такое claims и для чего они используются?
8. Как обработать истечение срока действия токена?
9. Какие методы защиты от перехвата JWT токена вы знаете?
10. Как реализовать разграничение доступа на основе нескольких ролей?

---

# README.md для студента (пример для Варианта 1)

# Практическая работа №X: Работа с JWT и ролями

**Название:** Реализация системы аутентификации и авторизации с JWT и ролями

**Вариант:** 1

**Задание:** Создайте API endpoint для регистрации новых пользователей с валидацией данных.

## Реализация

### Модель для регистрации
```csharp
public class RegisterModel
{
    [Required]
    [StringLength(50, MinimumLength = 3)]
    public string Username { get; set; }

    [Required]
    [EmailAddress]
    public string Email { get; set; }

    [Required]
    [StringLength(100, MinimumLength = 6)]
    public string Password { get; set; }

    [Required]
    public string Role { get; set; }
}
```

### Endpoint регистрации
```csharp
[HttpPost("register")]
public IActionResult Register([FromBody] RegisterModel model)
{
    // Валидация модели
    if (!ModelState.IsValid)
        return BadRequest(ModelState);

    // Проверка существования пользователя
    if (_users.Any(u => u.Username == model.Username))
        return BadRequest("Username already exists");

    // Создание нового пользователя
    var newUser = new User
    {
        Id = _users.Max(u => u.Id) + 1,
        Username = model.Username,
        Password = model.Password, // В реальном приложении хэшировать!
        Role = model.Role
    };

    _users.Add(newUser);

    return Ok(new { Message = "User registered successfully" });
}
```

## Скриншоты работы программы

![Регистрация пользователя](images/register-success.png)
*Успешная регистрация пользователя*

![Ошибка валидации](images/validation-error.png)
*Ошибка валидации данных*

## Запуск проекта

1. Клонируйте репозиторий
2. Восстановите зависимости: `dotnet restore`
3. Запустите проект: `dotnet run`
4. Откройте Swagger UI: `https://localhost:7000/swagger`

## Тестирование

Используйте Postman или Swagger для тестирования endpoints:
- POST `/api/auth/register` - регистрация
- POST `/api/auth/login` - вход
- GET `/api/admin/data` - данные для администраторов
- GET `/api/user/data` - данные для пользователей

Для выполнения задания студент должен:
1. Создать локальный репозиторий Git
2. Реализовать свой вариант задания
3. Сделать скриншоты работы программы
4. Оформить README.md согласно требованиям
5. Загрузить на Gogs сервер

Репозиторий должен содержать:
- `JwtRoleAuth.sln` - решение проекта
- `JwtRoleAuth/` - папка с проектом
- `images/` - папка со скриншотами
- `README.md` - описание работы