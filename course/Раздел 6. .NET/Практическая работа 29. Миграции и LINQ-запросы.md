# Практическая работа. Миграции и LINQ-запросы в Entity Framework

## Тема
Миграции и LINQ-запросы в Entity Framework Core

## Цель
Освоить навыки работы с миграциями Entity Framework Core и написания LINQ-запросов для взаимодействия с базой данных.

## Теоретическая часть

### Миграции в EF Core
Миграции позволяют поддерживать схему базы данных в соответствии с моделью данных приложения. Основные команды:
- `Add-Migration` - создает новую миграцию
- `Update-Database` - применяет миграции к базе данных
- `Remove-Migration` - удаляет последнюю миграцию

### LINQ-запросы
Language Integrated Query (LINQ) предоставляет единый синтаксис для запросов к различным источникам данных. Основные операции:
- `Where` - фильтрация данных
- `Select` - проекция данных
- `OrderBy` / `OrderByDescending` - сортировка
- `GroupBy` - группировка
- `Join` - соединение таблиц

## Практический пример

### Модель данных
```csharp
public class Student
{
    public int Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public int Age { get; set; }
    public string Group { get; set; }
    public decimal AverageGrade { get; set; }
}

public class Course
{
    public int Id { get; set; }
    public string Title { get; set; }
    public int Duration { get; set; }
    public decimal Price { get; set; }
}
```

### Контекст данных
```csharp
public class ApplicationDbContext : DbContext
{
    public DbSet<Student> Students { get; set; }
    public DbSet<Course> Courses { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("YourConnectionString");
    }
}
```

## Ход работы

1. Создать новый проект Console Application
2. Установить необходимые NuGet пакеты
3. Создать модели данных и контекст
4. Создать и применить миграции
5. Реализовать CRUD-операции
6. Написать LINQ-запросы согласно варианту задания

## Варианты заданий

### Вариант 1
Найти всех студентов с средним баллом выше 4.0

### Вариант 2
Вывести студентов определенной группы, отсортированных по фамилии

### Вариант 3
Найти студентов старше 20 лет с средним баллом ниже 3.5

### Вариант 4
Посчитать количество студентов в каждой группе

### Вариант 5
Найти средний балл по всем студентам

### Вариант 6
Вывести топ-5 студентов с наивысшим средним баллом

### Вариант 7
Найти студентов, чья фамилия начинается с определенной буквы

### Вариант 8
Обновить средний балл для студентов определенной группы

### Вариант 9
Удалить студентов с средним баллом ниже 2.0

### Вариант 10
Сгруппировать студентов по возрасту и вывести количество в каждой группе

### Вариант 11
Найти студентов с одинаковыми именами

### Вариант 12
Вывести распределение студентов по группам и средний балл в каждой группе

### Вариант 13
Найти самого старшего и самого младшего студента

### Вариант 14
Обновить группу для студентов с определенным средним баллом

### Вариант 15
Вывести студентов с средним баллом в определенном диапазоне

## Критерии оценки

### 5 (Отлично)
- Все задания выполнены полностью и корректно
- Код хорошо структурирован и документирован
- Использованы оптимальные подходы и лучшие практики
- Все скриншоты присутствуют и демонстрируют работу программы

### 4 (Хорошо)
- Задания выполнены с незначительными недочетами
- Код в основном корректный, но есть небольшие проблемы
- Не все лучшие практики соблюдены

### 3 (Удовлетворительно)
- Выполнены основные задания, но с существенными ошибками
- Код требует значительных доработок
- Не все требования выполнены

### 2 (Неудовлетворительно)
- Задания не выполнены или выполнены некорректно
- Код не работает или содержит критические ошибки

## Контрольные вопросы

1. Что такое миграции в Entity Framework Core?
2. Какие основные команды миграций вы знаете?
3. В чем разница между LINQ to Objects и LINQ to Entities?
4. Что такое отложенное выполнение (deferred execution) в LINQ?
5. Как выполнить немедленное выполнение LINQ-запросов?
6. Какие методы LINQ используются для фильтрации данных?
7. Как выполнить сортировку с помощью LINQ?
8. Что такое навигационные свойства в EF Core?
9. Как выполнить соединение таблиц с помощью LINQ?
10. Какие способы загрузки связанных данных существуют в EF Core?

---

# Реализация для варианта 1

## Структура проекта

```
EFMigrationLINQPractice/
├── Program.cs
├── Models/
│   ├── Student.cs
│   └── Course.cs
├── Data/
│   └── ApplicationDbContext.cs
├── Migrations/
├── Images/
│   ├── migration-applied.png
│   ├── program-output.png
│   └── database-tables.png
└── README.md
```

## Код реализации

### Models/Student.cs
```csharp
using System.ComponentModel.DataAnnotations;

namespace EFMigrationLINQPractice.Models
{
    public class Student
    {
        public int Id { get; set; }
        
        [Required]
        [MaxLength(50)]
        public string FirstName { get; set; }
        
        [Required]
        [MaxLength(50)]
        public string LastName { get; set; }
        
        public int Age { get; set; }
        
        [MaxLength(20)]
        public string Group { get; set; }
        
        public decimal AverageGrade { get; set; }
    }
}
```

### Data/ApplicationDbContext.cs
```csharp
using Microsoft.EntityFrameworkCore;
using EFMigrationLINQPractice.Models;

namespace EFMigrationLINQPractice.Data
{
    public class ApplicationDbContext : DbContext
    {
        public DbSet<Student> Students { get; set; }
        public DbSet<Course> Courses { get; set; }

        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        {
            optionsBuilder.UseSqlServer(@"Server=(localdb)\mssqllocaldb;Database=StudentDB;Trusted_Connection=true;");
        }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            // Seed data
            modelBuilder.Entity<Student>().HasData(
                new Student { Id = 1, FirstName = "Иван", LastName = "Петров", Age = 20, Group = "ИТ-101", AverageGrade = 4.5m },
                new Student { Id = 2, FirstName = "Мария", LastName = "Иванова", Age = 19, Group = "ИТ-101", AverageGrade = 4.8m },
                new Student { Id = 3, FirstName = "Алексей", LastName = "Сидоров", Age = 21, Group = "ИТ-102", AverageGrade = 3.9m },
                new Student { Id = 4, FirstName = "Екатерина", LastName = "Кузнецова", Age = 20, Group = "ИТ-102", AverageGrade = 4.2m },
                new Student { Id = 5, FirstName = "Дмитрий", LastName = "Смирнов", Age = 22, Group = "ИТ-103", AverageGrade = 3.7m }
            );
        }
    }
}
```

### Program.cs
```csharp
using EFMigrationLINQPractice.Data;
using EFMigrationLINQPractice.Models;
using Microsoft.EntityFrameworkCore;

namespace EFMigrationLINQPractice
{
    class Program
    {
        static void Main(string[] args)
        {
            using (var context = new ApplicationDbContext())
            {
                // Ensure database is created
                context.Database.EnsureCreated();

                // Вариант 1: Найти всех студентов с средним баллом выше 4.0
                Console.WriteLine("=== Студенты с средним баллом выше 4.0 ===");
                
                var highAchievers = context.Students
                    .Where(s => s.AverageGrade > 4.0m)
                    .OrderByDescending(s => s.AverageGrade)
                    .ToList();

                foreach (var student in highAchievers)
                {
                    Console.WriteLine($"{student.LastName} {student.FirstName} - Группа: {student.Group} - Средний балл: {student.AverageGrade}");
                }

                // Дополнительные примеры LINQ-запросов
                Console.WriteLine("\n=== Дополнительные запросы ===");
                
                // Количество студентов в каждой группе
                var studentsByGroup = context.Students
                    .GroupBy(s => s.Group)
                    .Select(g => new { Group = g.Key, Count = g.Count() })
                    .ToList();

                Console.WriteLine("\nКоличество студентов по группам:");
                foreach (var group in studentsByGroup)
                {
                    Console.WriteLine($"Группа {group.Group}: {group.Count} студентов");
                }

                // Средний балл по группам
                var averageByGroup = context.Students
                    .GroupBy(s => s.Group)
                    .Select(g => new { Group = g.Key, AverageGrade = g.Average(s => s.AverageGrade) })
                    .ToList();

                Console.WriteLine("\nСредний балл по группам:");
                foreach (var group in averageByGroup)
                {
                    Console.WriteLine($"Группа {group.Group}: {group.AverageGrade:F2}");
                }
            }

            Console.WriteLine("\nНажмите любую клавишу для выхода...");
            Console.ReadKey();
        }
    }
}
```

## Миграции

### Создание миграции
```bash
Add-Migration InitialCreate
Update-Database
```

## README.md

```markdown
# Практическая работа №3: Миграции и LINQ-запросы в EF Core

**Вариант:** 1

**Задание:** Найти всех студентов с средним баллом выше 4.0

## Реализация

### Модель данных
```csharp
public class Student
{
    public int Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public int Age { get; set; }
    public string Group { get; set; }
    public decimal AverageGrade { get; set; }
}
```

### LINQ-запрос
```csharp
var highAchievers = context.Students
    .Where(s => s.AverageGrade > 4.0m)
    .OrderByDescending(s => s.AverageGrade)
    .ToList();
```

## Результаты выполнения

### Скриншот работы программы
![Результат выполнения программы](Images/program-output.png)

### Скриншот базы данных
![Таблицы базы данных](Images/database-tables.png)

### Скриншот миграций
![Примененные миграции](Images/migration-applied.png)

## Запуск проекта

1. Клонировать репозиторий
2. Восстановить NuGet пакеты
3. Выполнить команды миграции
4. Запустить проект

```bash
dotnet restore
dotnet ef database update
dotnet run
```
```

## Установка и настройка Gogs

### Локальная установка Gogs
```bash
# Скачать Gogs
docker run -d --name=gogs -p 10022:22 -p 10080:3000 -v /tmp/gogs:/data gogs/gogs
```

### Настройка репозитория
1. Открыть http://localhost:10080
2. Создать учетную запись
3. Создать новый репозиторий "EFMigrationLINQPractice"
4. Следовать инструкциям для загрузки кода

### Команды для загрузки в Gogs
```bash
git init
git add .
git commit -m "Практическая работа: Миграции и LINQ-запросы в EF Core"
git remote add origin http://localhost:10080/username/EFMigrationLINQPractice.git
git push -u origin main
```
