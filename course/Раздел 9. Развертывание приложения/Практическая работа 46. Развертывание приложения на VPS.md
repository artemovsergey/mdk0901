# Практическая работа. Развертывание Full-Stack приложения на VPS

**Тема:** Развертывание и настройка Full-Stack приложения (.NET + Angular) на виртуальном частном сервере (VPS) с использованием Nginx как reverse proxy.

**Цель:** Приобрести практические навыки по подготовке VPS, настройке веб-сервера, сборке production-версий приложений и их развертыванию в среде, приближенной к реальной.

**Ход работы:**
1.  Ознакомиться с теоретической частью.
2.  Получить вариант задания по номеру в журнале.
3.  Подготовить VPS (или использовать локальную виртуальную машину).
4.  Настроить окружение на сервере (установить .NET Runtime, Nginx).
5.  Собрать production-версии Backend (ASP.NET Core Web API) и Frontend (Angular) приложений.
6.  Настроить Nginx в качестве reverse proxy для Backend API и для раздачи статических файлов Frontend.
7.  Настроить приложение как системный сервис с помощью `systemd` для обеспечения постоянной работы.
8.  Проверить работоспособность развернутого приложения.
9.  Зафиксировать все шаги, включая скриншоты результатов, в `README.md` и отправить работу в репозиторий Gogs.

---

### **Теоретическая часть**

1.  **VPS (Virtual Private Server)** — виртуальный сервер, эмулирующий работу выделенного физического сервера. Имеет свою ОС, root-доступ и выделенные ресурсы (CPU, RAM, SSD).
2.  **SSH (Secure Shell)** — сетевой протокол для безопасного удаленного управления операционной системой.
3.  **Nginx** — высокопроизводительный HTTP-сервер и обратный прокси (reverse proxy). Он может:
    *   Раздавать статические файлы (скомпилированное Angular-приложение).
    *   Выступать в роли прокси для ASP.NET Core приложения, перенаправляя запросы с порта 80/443 на порт, который слушает Kestrel (веб-сервер .NET).
4.  **Kestrel** — это кроссплатформенный веб-сервер для ASP.NET Core. В продакшене он обычно работает за reverse proxy (Nginx, Apache).
5.  **Systemd** — система инициализации и менеджер служб в большинстве Linux-дистрибутивов. Позволяет управлять процессами как сервисами (запуск, остановка, автозапуск при загрузке).
6.  **Доменное имя & DNS** - символьное имя, предназначенное для идентификации областей в Интернете. DNS (Domain Name System) связывает доменное имя с IP-адресом вашего VPS.

---

### **Практический пример (Общий для всех)**

**Задача:** Развернуть простое приложение "To-Do List" на VPS с ОС Ubuntu 22.04.
*   **Backend:** ASP.NET Core Web API (`http://localhost:5000`).
*   **Frontend:** Angular SPA.

**Шаги:**

1.  **Подготовка VPS:**
    *   Войти на сервер по SSH: `ssh root@your_server_ip`.
    *   Обновить пакеты: `sudo apt update && sudo apt upgrade -y`.
    *   Установить .NET Runtime: `sudo apt install aspnetcore-runtime-8.0 -y`.
    *   Установить Nginx: `sudo apt install nginx -y`.

2.  **Подготовка приложения:**
    *   **Backend:** В папке проекта выполнить `dotnet publish -c Release -o ./publish`. Скопировать содержимое папки `publish` на сервер в `/var/www/todo-api/`.
    *   **Frontend:** Выполнить `ng build --configuration production`. Скопировать содержимое папки `dist/your-app-name` на сервер в `/var/www/todo-app/`.

3.  **Настройка Backend как сервиса:**
    *   Создать файл сервиса: `sudo nano /etc/systemd/system/todo-api.service`
    *   Добавить конфигурацию:
        ```ini
        [Unit]
        Description=Todo API .NET Web API Application

        [Service]
        WorkingDirectory=/var/www/todo-api
        ExecStart=/usr/bin/dotnet /var/www/todo-api/YourApiName.dll
        Restart=always
        RestartSec=10
        SyslogIdentifier=dotnet-todo-api
        User=www-data
        Environment=ASPNETCORE_ENVIRONMENT=Production
        Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

        [Install]
        WantedBy=multi-user.target
        ```
    *   Запустить сервис: `sudo systemctl enable todo-api.service && sudo systemctl start todo-api.service`

4.  **Настройка Nginx:**
    *   Создать конфигурационный файл: `sudo nano /etc/nginx/sites-available/todo-app`
    *   Добавить конфигурацию, которая проксирует запросы к API на порт 5000, а все остальные запросы отдает на статику Angular:
        ```nginx
        server {
            listen 80;
            server_name your_domain.com www.your_domain.com; # или IP-адрес

            location / {
                root /var/www/todo-app;
                try_files $uri $uri/ /index.html;
            }

            location /api/ {
                proxy_pass http://localhost:5000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection keep-alive;
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }
        ```
    *   Активировать сайт: `sudo ln -s /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/`
    *   Проверить конфигурацию и перезапустить Nginx: `sudo nginx -t && sudo systemctl restart nginx`

5.  **Проверка:** Открыть в браузере `http://your_server_ip`. Должно загрузиться Angular-приложение, которое может взаимодействовать с API.

---

### **Варианты заданий (15 шт.)**

*Студент выполняет задание, соответствующее его номеру в журнале.*

1.  **Простой список дел:** Разверните приложение "To-Do List" (одна сущность `Task` с полями Id, Title, IsCompleted). API должен иметь CRUD-операции.
2.  **Блог (Только статьи):** Разверните простой блог. Сущность `Post` (Id, Title, Content, CreatedDate). API: получение всех постов и одного поста по ID.
3.  **Гостевая книга:** Разверните приложение "Гостевая книга". Сущность `GuestbookEntry` (Id, AuthorName, Message, DateAdded). API: добавление и получение записей.
4.  **Список продуктов:** Разверните приложение "Каталог продуктов". Сущность `Product` (Id, Name, Price, Description). API: CRUD для продуктов.
5.  **Опросник:** Разверните приложение с одним вопросом и вариантами ответов (например, "Какой ваш любимый язык программирования?"). Сущность `Vote`. API: отправка голоса и получение результатов.
6.  **Погодный виджет (Заглушка):** Разверните приложение, которое показывает "погоду". Backend возвращает фиктивные данные (город, температура). Frontend отображает их.
7.  **Счетчик посещений:** Разверните приложение, которое при каждом заходе на главную страницу увеличивает счетчик на бэкенде и отображает его.
8.  **Менеджер контактов:** Разверните приложение "Телефонная книга". Сущность `Contact` (Id, Name, Phone, Email).
9.  **Коллекция фильмов:** Разверните приложение "Моя коллекция фильмов". Сущность `Movie` (Id, Title, Director, Year).
10. **Доска объявлений:** Разверните приложение для простых объявлений. Сущность `Advert` (Id, Title, Description, ContactEmail).
11. **Список книг для чтения:** Разверните приложение "Список для чтения". Сущность `Book` (Id, Title, Author, IsRead).
12. **Учет личных финансов:** Разверните приложение для учета доходов/расходов. Сущность `Transaction` (Id, Description, Amount, Date, Type [Income/Expense]).
13. **Список сотрудников:** Разверните приложение "Список сотрудников". Сущность `Employee` (Id, FirstName, LastName, Position).
14. **Каталог университетских курсов:** Разверните приложение с курсами. Сущность `Course` (Id, Name, Description).
15. **Сбор отзывов:** Разверните приложение для сбора отзывов. Сущность `Feedback` (Id, AuthorName, Text, Rating(1-5)).

---

### **Критерии оценки**

*   **5 (Отлично):**
    *   Приложение полностью развернуто и доступно по IP/домену.
    *   Frontend и Backend корректно взаимодействуют.
    *   Nginx сконфигурирован как reverse proxy.
    *   Backend работает как системный сервис.
    *   Репозиторий в Gogs содержит полный код проекта, `README.md` оформлен по всем требованиям с подробным описанием шагов, скриншотами и подсветкой синтаксиса.
*   **4 (Хорошо):**
    *   Приложение развернуто, но есть незначительные ошибки (например, проблемы с путями в Angular, не все функции API работают).
    *   `README.md` содержит описание и скриншоты, но есть неточности в оформлении кода или описании шагов.
*   **3 (Удовлетворительно):**
    *   Развернута только одна часть приложения (только Backend или только Frontend).
    *   Отсутствует настройка Nginx или сервиса `systemd`.
    *   `README.md` оформлен poorly, с минимальным описанием или без скриншотов.
*   **2 (Неудовлетворительно):**
    *   Приложение не развернуто.
    *   Работа не сдана или `README.md` отсутствует.

---

### **Контрольные вопросы**

1.  Почему в продакшене ASP.NET Core приложение обычно запускают за reverse proxy (Nginx), а не напрямую на Kestrel?
2.  Какова роль директивы `try_files` в конфигурации Nginx для Angular-приложения?
3.  Для чего нужен `systemd` в процессе развертывания?
4.  Какие команды используются для управления сервисом `todo-api` (запуск, остановка, проверка статуса)?
5.  Что такое `dotnet publish` и чем он отличается от `dotnet build`?
6.  Как перенаправить HTTP-трафик на HTTPS с помощью Nginx?
7.  Какие порты по умолчанию используются для HTTP и HTTPS? Нужно ли их открывать в фаерволе?

---

### **Структура репозитория в Gogs**

```
your-gogs-repo/
│
├── TodoApp.sln                 # Решение .NET
├── backend/
│   ├── Controllers/
│   ├── Models/
│   ├── Program.cs
│   └── TodoApi.csproj
├── frontend/
│   ├── src/
│   ├── angular.json
│   ├── package.json
│   └── tsconfig.json
├── images/                     # Папка со скриншотами
│   ├── main-page.png
│   ├── api-working.png
│   └── nginx-config.png
└── README.md                   # Основной файл отчета
```

---

### **Пример содержимого файла `README.md` для варианта №1**

```markdown
# Практическая работа №X: Развертывание Full-Stack приложения на VPS

**ФИО:** Иванов Иван
**Группа:** ИТ-41
**Вариант:** 1

## Задание
Развернуть приложение "To-Do List" на VPS с ОС Ubuntu 22.04. Backend - ASP.NET Core Web API, Frontend - Angular. Настроить Nginx как reverse proxy и запустить backend как системный сервис.

## Ход работы

### 1. Подготовка сервера
Подключился к VPS по SSH и установил необходимое ПО.
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install aspnetcore-runtime-8.0 nginx -y
```

### 2. Публикация приложения
Опубликовал backend и сбилдил frontend.

**Backend:**
```bash
dotnet publish -c Release -o ./publish
```
**Frontend:**
```bash
ng build --configuration production
```

### 3. Настройка сервиса для Backend
Создал файл `/etc/systemd/system/todo-api.service`:
```ini
[Unit]
Description=Todo API .NET Web API Application

[Service]
WorkingDirectory=/var/www/todo-api
ExecStart=/usr/bin/dotnet /var/www/todo-api/TodoApi.dll
Restart=always
# ... остальная конфигурация
```
Запустил сервис:
```bash
sudo systemctl enable todo-api.service
sudo systemctl start todo-api.service
```
![Статус сервиса](images/service-status.png)
*Рис. 1: Сервис todo-api успешно запущен.*

### 4. Настройка Nginx
Создал конфигурационный файл `/etc/nginx/sites-available/todo-app`:
```nginx
server {
    listen 80;
    server_name 192.168.1.100;

    location / {
        root /var/www/todo-app;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:5000;
        # ... прокси-заголовки
    }
}
```
![Конфиг Nginx](images/nginx-config.png)
*Рис. 2: Конфигурация Nginx.*

### 5. Результат
Приложение успешно запущено и доступно по IP-адресу.
![Главная страница](images/main-page.png)
*Рис. 3: Работающее приложение в браузере.*

![Работа API](images/api-working.png)
*Рис. 4: Ответ от API `/api/tasks`, полученный через браузер.*
```
