# Практическая работа 1. Настройка CI/CD пайплайна в GitLab для .NET приложения

### **Тема**
Автоматизация процесса сборки, тестирования и развертывания .NET приложения с использованием GitLab CI/CD.

### **Цель**
Научиться создавать и настраивать непрерывную интеграцию и непрерывное развертывание (CI/CD) для ASP.NET Core приложения с помощью GitLab CI/CD. Студенты освоят основы написания файла `.gitlab-ci.yml`, работы с Docker, запуска тестов и автоматизации деплоя.

---

## **Теоретическая часть**

**CI/CD (Continuous Integration / Continuous Deployment)** — это практика автоматизации процессов сборки, тестирования и развертывания приложений.

- **Continuous Integration (Непрерывная интеграция)**:
  - Автоматическая сборка при каждом коммите в репозиторий
  - Запуск автоматических тестов
  - Выявление конфликтов и ошибок на ранних этапах

- **Continuous Deployment (Непрерывное развертывание)**:
  - Автоматическое развертывание приложения после успешной сборки
  - Минимальное время между написанием кода и его доставкой в продакшн

**GitLab CI/CD** использует файл `.gitlab-ci.yml` в корне репозитория для определения пайплайна. Пайплайн состоит из:
- **Stages** (Этапы) - последовательность стадий (build, test, deploy)
- **Jobs** (Задания) - конкретные задачи внутри стадий
- **Runners** - машины, которые выполняют задания

**Docker** используется для создания изолированных сред выполнения и упаковки приложения в контейнеры.

---

## **Практический пример**

### **Структура проекта**
```
MyWebApp/
├── MyWebApp/
│   ├── Controllers/
│   ├── Models/
│   ├── Program.cs
│   ├── MyWebApp.csproj
│   └── appsettings.json
├── tests/
│   └── MyWebApp.Tests/
│       └── UnitTest1.cs
├── images/
│   └── program-screenshot.png
├── .gitlab-ci.yml
├── Dockerfile
└── README.md
```

### **Пример .gitlab-ci.yml**
```yaml
stages:
  - build
  - test
  - deploy

variables:
  NUGET_PATH: './nuget'

before_script:
  - dotnet restore

build:
  stage: build
  script:
    - dotnet build --configuration Release --no-restore
  artifacts:
    paths:
      - "**/bin/Release/**/*.dll"
    expire_in: 1 hour
  only:
    - main
    - develop

test:
  stage: test
  script:
    - dotnet test --no-build --verbosity normal
  dependencies:
    - build

deploy:
  stage: deploy
  script:
    - echo "Deploying application..."
    - docker build -t my-web-app .
    - docker run -d -p 8080:80 --name my-running-app my-web-app
  only:
    - main
```

### **Пример Dockerfile**
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["MyWebApp/MyWebApp.csproj", "MyWebApp/"]
RUN dotnet restore "MyWebApp/MyWebApp.csproj"
COPY . .
WORKDIR "/src/MyWebApp"
RUN dotnet build "MyWebApp.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "MyWebApp.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "MyWebApp.dll"]
```

---

## **Ход работы**

1. **Подготовка окружения**
   - Установить Git, .NET SDK, Docker
   - Зарегистрироваться на GitLab или настроить локальный Gogs

2. **Создание проекта**
   - Создать ASP.NET Core Web API приложение
   - Добавить unit-тесты
   - Создать Dockerfile для контейнеризации

3. **Настройка CI/CD**
   - Создать файл `.gitlab-ci.yml` в корне репозитория
   - Настроить этапы сборки, тестирования и деплоя
   - Добавить переменные окружения при необходимости

4. **Тестирование пайплайна**
   - Сделать коммит и пуш в репозиторий
   - Проверить выполнение пайплайна в GitLab
   - Убедиться, что все этапы выполняются успешно

5. **Документирование**
   - Сделать скриншоты работающего приложения и пайплайна
   - Заполнить README.md согласно требованиям
   - Выложить готовую работу на Gogs

---

## **Варианты заданий**

**Вариант 1:** Настройте пайплайн с тремя этапами: build, test, deploy. Добавьте кэширование NuGet пакетов.

**Вариант 2:** Создайте пайплайн, который запускает тесты только для измененных проектов.

**Вариант 3:** Настройте деплой в Docker контейнер с публикацией образа в GitLab Container Registry.

**Вариант 4:** Реализуйте пайплайн с ручным подтверждением для этапа деплоя в прод.

**Вариант 5:** Добавьте этап статического анализа кода с помощью SonarQube.

**Вариант 6:** Настройте пайплайн с разными сценариями для веток main, develop и feature/*.

**Вариант 7:** Реализуйте пайплайн с параллельным выполнением unit-тестов и интеграционных тестов.

**Вариант 8:** Добавьте этап создания документации с помощью Swagger/OpenAPI.

**Вариант 9:** Настройте пайплайн с развертыванием в разные среды (dev, staging, prod).

**Вариант 10:** Реализуйте откат деплоя (rollback) при неудачных тестах.

**Вариант 11:** Добавьте этап проверки безопасности зависимостей (dependency scanning).

**Вариант 12:** Настройте пайплайн с выполнением performance-тестов.

**Вариант 13:** Реализуйте пайплайн с созданием и публикацией NuGet пакета.

**Вариант 14:** Добавьте этап отправки уведомлений в Telegram/Slack о статусе пайплайна.

**Вариант 15:** Настройте пайплайн с использованием матрицы сборок для разных версий .NET.

---

## **Критерии оценки**

**5 (Отлично):**
- Все этапы пайплайна работают корректно
- Приложение успешно собирается, тестируется и деплоится
- Код хорошо структурирован, соблюдаются best practices
- README.md полностью заполнен с скриншотами
- Дополнительные требования варианта полностью реализованы

**4 (Хорошо):**
- Основные этапы пайплайна работают (build, test)
- Есть незначительные ошибки в конфигурации
- README.md заполнен, но есть небольшие недочеты
- Дополнительные требования реализованы частично

**3 (Удовлетворительно):**
- Пайплайн запускается, но некоторые этапы завершаются с ошибками
- README.md заполнен минимально
- Базовый функционал работает

**2 (Неудовлетворительно):**
- Пайплайн не работает
- README.md не заполнен или заполнен некорректно
- Задание не выполнено

---

## **Контрольные вопросы**

1. Что такое CI/CD и какие преимущества дает его использование?
2. Какие основные этапы typically включаются в CI/CD пайплайн?
3. Как работает GitLab Runner и для чего он нужен?
4. Что такое артефакты в GitLab CI и для чего они используются?
5. Как организовать хранение чувствительных данных (паролей, ключей) в пайплайне?
6. Какие отличия между `.gitlab-ci.yml` и GitHub Actions?
7. Как настроить разные сценарии для разных веток в GitLab CI?
8. Что такое Docker multistage build и какие преимущества он дает?
9. Как организовать кэширование в GitLab CI для ускорения сборки?
10. Какие инструменты анализа кода можно интегрировать в пайплайн?

---

## **Пример README.md для студента**

```markdown
# Практическая работа №5: Настройка CI/CD пайплайна в GitLab

**Вариант:** 3

**Задание:** Настройте деплой в Docker контейнер с публикацией образа в GitLab Container Registry.

## Реализация

### Структура проекта
```
MyWebApp/
├── MyWebApp/
├── tests/
├── images/
├── .gitlab-ci.yml
├── Dockerfile
└── README.md
```

### Файл .gitlab-ci.yml
```yaml
stages:
  - build
  - test
  - publish
  - deploy

variables:
  CONTAINER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

build:
  stage: build
  script:
    - dotnet restore
    - dotnet build --configuration Release --no-restore
  artifacts:
    paths:
      - "**/bin/Release/**/*.dll"

test:
  stage: test
  script:
    - dotnet test --no-build --verbosity normal

publish:
  stage: publish
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CONTAINER_IMAGE .
    - docker push $CONTAINER_IMAGE
  only:
    - main

deploy:
  stage: deploy
  script:
    - docker pull $CONTAINER_IMAGE
    - docker run -d -p 8080:80 --name my-app $CONTAINER_IMAGE
  only:
    - main
```

### Dockerfile
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["MyWebApp/MyWebApp.csproj", "MyWebApp/"]
RUN dotnet restore "MyWebApp/MyWebApp.csproj"
COPY . .
WORKDIR "/src/MyWebApp"
RUN dotnet build "MyWebApp.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "MyWebApp.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "MyWebApp.dll"]
```

## Результаты

### Скриншот работающего пайплайна
![GitLab Pipeline](images/pipeline-success.png)

### Скриншот приложения
![Application](images/app-running.png)

### Скриншот Container Registry
![Container Registry](images/container-registry.png)
```

---

## **Инструкция для студентов**

1. **Клонируйте этот шаблон** и адаптируйте под свой вариант
2. **Создайте ASP.NET Core Web API** приложение с несколькими контроллерами
3. **Добавьте unit-тесты** для проверки функциональности
4. **Реализуйте задание** согласно вашему варианту из журнала
5. **Настройте Gogs репозиторий** и выполните push готового проекта
6. **Убедитесь**, что пайплайн выполняется успешно на всех этапах
7. **Заполните README.md** согласно шаблону с скриншотами
